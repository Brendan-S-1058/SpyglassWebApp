<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crow's Nest</title>
  <link rel="icon" type="image/x-icon" href="favico/favicon.ico">
  <link href="datastyle.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4" id="table">
    <div id="title">
      <h1 class="text-3xl font-bold mb-4">Processed Data Dashboard</h1>
    </div>
    <div class="mb-4 flex justify-between items-center">
          <input id="Search" type="text" placeholder="Search..." class="button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"></input>
          <button id="searchButton" class="button">Search</button>
          <button id="Public" class="On">Pull From Public</button>
          <button id="explain" class="button">Explain</button>
      </div>
  </div>
  <div class="overflow-auto border rounded-lg shadow bg-white">
    <table class="min-w-full table-fixed borderCollapse">
      <thead class="bg-gray-200 text-left borderCollapse">
        <tr class = "borderCollapse">
            <th class="p-2 border">match #</th>
            <th class="p-2 border">team #</th>
            <th class="p-2 border">alliance</th>
            <th class="p-2 border">auto fuel</th>
            <th class="p-2 border">auto climb</th>
            <th class="p-2 border">feed</th>
            <th class="p-2 border">tele fuel</th>
            <th class="p-2 border">tele climb</th> 
            <th class="p-2 border">shots missed</th>
            <th class="p-2 border">can bumb</th>
            <th class="p-2 border">can trench</th>
            <th class="p-2 border">defense</th>
            <th class="p-2 border">auto total</td>
            <th class="p-2 border">tele total</td>
            <th class="p-2 border">total</td>
            <th class="p-2 border">fuel total</td>
            <th class="p-2 border">climb total</td>
            <th class="p-2 border">fuel %</td> 
            <th class="p-2 border">climb %</td> 
            <th class="p-2 border">accuracy</th>
            <th class="p-2 border">comments</th>
        </tr>
      </thead>
      <tbody id="data-table-body">
      </tbody>
    </table>
    <p>


    </p>
    <table class="min-w-full table-fixed" id="sideTable">
      <thead>
        <tr id="maxS">
          <th>Max score:</th>
        </tr>
        <tr id="medS">
          <th>Median score:</th>
        </tr>
        <tr id="avgS">
          <th>Average score:</th>
        </tr>
        <tr id="Acc%">
          <th>Accuracy:</th>
        </tr>
        <tr id="Aclimb%">
          <th>Auto Climb consistency:</th>
        </tr>
        <tr id="Tclimb%">
          <th>Tele Climb consistency:</th>
        </tr>
        <tr id="Taclimb%">
          <th>Tele Climb Avg Height:</th>
        </tr>
        <tr id="avgAuto">
          <th>Auto avg score:</th>
        </tr>
        <tr id="Afuel">
          <th>Auto avg Fuel:</th>
        </tr>
        <tr id="avgTele">
          <th>Tele avg score:</th>
        </tr>
        <tr id="avgFuel">
          <th>fuel avg score:</th>
        </tr>
        <tr id="avgClimb">
          <th>climb avg score:</th>
        </tr>
        <tr id="fuel%">
          <th>fuel % avg:</th>
        </tr>
        <tr id="climb%">
          <th>climb % avg:</th>
        </tr>
        <tr id="auto%">
          <th>auto % avg:</th>
        </tr>
        <tr id="tele%">
          <th>tele % avg:</th>
        </tr>
      </thead>
    </table>
    <p>


    </p>
    </div>
    <div id="images" class="adjacent-graph"></div>
</body>
<script>
    let public = 1;

    const qrs = JSON.parse(localStorage.getItem("qrCodes"));
    const tableBody = document.getElementById("data-table-body");
    const newMax = document.createElement('td');
    const newMed = document.createElement('td');
    const newAvg = document.createElement('td');
    const newAcc = document.createElement('td');
    const newaCC = document.createElement('td');
    const newtCC = document.createElement('td');
    const newtaCC = document.createElement('td');
    const newFuelper = document.createElement('td');
    const newAFuel = document.createElement('td');
    const newCper = document.createElement('td');
    const newTeleTotAvg = document.createElement('td');
    const newAutoTotAvg = document.createElement('td');
    const newAutoAvgP = document.createElement('td');
    const newTeleAvgP = document.createElement('td');
    const newavgFuel= document.createElement('td');
    const newavgClimb = document.createElement('td');

    document.getElementById('Public').addEventListener("click", () => {
      public += 1;

      if (public > 2) {
        public = 0;
      }
      if (public == 0){
        document.getElementById('Public').style.color = "#ff0000";
      } else if (public == 1) {
        document.getElementById('Public').style.color = "#00ff00";
      } else {
        document.getElementById('Public').style.color = "#0000ff";
      }
    });

    document.getElementById("searchButton").addEventListener("click", async () => {
      const searchTerm = document.getElementById("Search").value.toLowerCase();
      let values = [];
      tableBody.innerHTML = '';
      newMax.innerHTML = '';
      newMed.innerHTML = '';
      newAvg.innerHTML = '';
      newaCC.innerHTML = '';
      newAcc.innerHTML = '';
      newtCC.innerHTML = '';
      newtaCC.innerHTML = '';
      newCper.innerHTML = '';
      newFuelper.innerHTML = '';
      newAFuel.innerHTML = '';
      newTeleTotAvg.innerHTML = '';
      newAutoTotAvg.innerHTML = '';
      newAutoAvgP.innerHTML = '';
      newTeleAvgP.innerHTML = '';
      newavgFuel.innerHTML = '';
      newavgClimb.innerHTML = '';
      if (public == 0) {
        values.push (localStorage.getItem('team'));
        qrs.forEach(qr => {
          if (qr.includes(searchTerm)) {
            values.push(qr);
          }
        })
      } else if (public == 1){
        values.push(searchTerm);
      } else {
        values.push (localStorage.getItem('team'));
        values.push (searchTerm)
      }
      console.log(values)
      let parsedData;
      try {
        parsedData = await runPythonScript(values);
        console.log ('parsedData: ' + parsedData);
      } catch (e) {
        console.error(e);
        return;
      }
      parsedData.forEach(line => {
            console.log (line);
            createRow(line);
        });
      let overallData;
      try {
        overallData = await overallProcess(parsedData);
      } catch (e) {
        console.error(e);
        return;
      }
      createCol(overallData);

      try {
        const g1 = document.createElement('img');
        g1.src = "data/Teams/" + localStorage.getItem('team') + '/' + localStorage.getItem('team') + 'Graphs' + '/' + searchTerm + ".png";
        g1.width = 600;
        g1.height = 400;

        const space = document.createElement('p');
        space.innerHTML = '&nbsp;'; // optional: creates a visible space

        const g2 = document.createElement('img');
        g2.src = "data/Teams/" + localStorage.getItem('team') + '/' + localStorage.getItem('team') + 'Graphs' + '/' + searchTerm + "avt.png";
        g2.width = 600;
        g2.height = 400;

        const division = document.getElementById("images");
        division.innerHTML='';

        division.appendChild(g1);
        division.appendChild(space);
        division.appendChild(g2);
      } catch (e) {
        console.error("Graphs not loaded. Check search term and make sure you submitted data on the raw page.");
        console.error(e);
        return;
      }
      
      });
  console.log(qrs);

  function createCol(csv){
    const fields = csv.split(",").map(s => s.trim().replace(/[\["\/]/g, ""));
    if (fields.length !== 16) {
      console.error("OOOH SOMEBODY doesn't know how to count (it's me)");
    }
    const [
    Maxscore, Medianscore, Averagescore, acc, aClimbconsistency, tClimbconsistency, tClimbavg, fuelAavg, autoavg, teleavg, fuelTavg, climbTavg, autoTavg, teleTavg, fuelAvg, ClimbAvg
    ] = fields;

    const maxR = document.getElementById('maxS');
    const medR = document.getElementById('medS');
    const avgR = document.getElementById('avgS');
    const accp = document.getElementById('Acc%');
    const aClimbPR = document.getElementById('Aclimb%');
    const tClimbPR = document.getElementById('Tclimb%');
    const taClimbPR = document.getElementById('Taclimb%');
    const climbPR = document.getElementById('climb%');
    const fuelPR = document.getElementById('fuel%');
    const fuelAPR = document.getElementById('Afuel');
    const autoR = document.getElementById('avgAuto');
    const teleR = document.getElementById('avgTele');
    const avgFuel = document.getElementById('avgFuel');
    const avgClimb = document.getElementById('avgClimb');
    const autoPR = document.getElementById('auto%');
    const telePR = document.getElementById('tele%');

    newMax.innerHTML = Maxscore;
    newMed.innerHTML = Medianscore;
    newAvg.innerHTML = Averagescore;
    newaCC.innerHTML = aClimbconsistency;
    newAcc.innerHTML = acc;
    newtCC.innerHTML = tClimbconsistency;
    newtaCC.innerHTML = tClimbavg;
    newCper.innerHTML = climbTavg;
    newFuelper.innerHTML = fuelTavg;
    newAFuel.innerHTML = fuelAavg;
    newTeleAvgP.innerHTML = teleavg;
    newavgFuel.innerHTML = fuelAvg;
    newavgClimb.innerHTML = climbAvg;
    newAutoAvgP.innerHTML = autoavg;
    newAutoTotAvg.innerHTML = teleTavg;
    newTeleTotAvg.innerHTML = autoTavg;

    maxR.appendChild(newMax);
    medR.appendChild(newMed);
    avgR.appendChild(newAvg);
    aClimbPR.appendChild(newaCC);
    accp.appendChild(newAcc);
    tClimbPR.appendChild(newtCC);
    taClimbPR.appendChild(newtaCC);
    climbPR.appendChild(newCper);
    fuelPR.appendChild(newFuelper);
    fuelAPR.appendChild(newAFuel);
    telePR.appendChild(newTeleTotAvg);
    autoPR.appendChild(newAutoTotAvg);
    avgFuel.appendChild(newavgFuel);
    avgClimb.appendChild(newavgClimb);
    teleR.appendChild(newTeleAvgP);
    autoR.appendChild(newAutoAvgP);

  }

    function createRow(csv){
        const fields = csv.split(",").map(s => s.trim().replace(/[\["\/]/g, ""));
        if (fields.length !== 21) {
          console.error("createRow: expected 21 commaâ€‘separated values, got", fields.length);
          return;
        }
        const [
          match, team, alliance,
          autoFuel, autoClimb, feed, teleFuel, teleClimb, shotsMissed, canBump,
          canTrench, defense, comments,
          autoTotal, teleTotal, total, fuelTotal, climbTotal, fuelper, climbper, acc
        ] = fields;

        const table = document.getElementById("data-table-body");
        const newRow = document.createElement('tr');
        newRow.contentEditable = "false";
        newRow.innerHTML = `
            <th class="p-2 border">`+match+`</th>
            <th class="p-2 border">`+team+`</th>
            <th class="p-2 border">`+alliance+`</th>
            <th class="p-2 border">`+autoFuel+`</th>
            <th class="p-2 border">`+autoClimb+`</th>
            <th class="p-2 border">`+feed+`</th>
            <th class="p-2 border">`+teleFuel+`</th>
            <th class="p-2 border">`+teleClimb+`</th>
            <th class="p-2 border">`+shotsMissed+`</th>
            <th class="p-2 border">`+canBump+`</th>
            <th class="p-2 border">`+canTrench+`</th>
            <th class="p-2 border">`+defense+`</th>
            <th class="p-2 border">`+autoTotal+`</td>
            <th class="p-2 border">`+teleTotal+`</td>
            <th class="p-2 border">`+total+`</td>
            <th class="p-2 border">`+fuelTotal+`</td>
            <th class="p-2 border">`+climbTotal+`</td>
            <th class="p-2 border">`+fuelper+`</td>
            <th class="p-2 border">`+climbper+`</td>
            <th class="p-2 border">`+acc+`</th>
            <th class="p-2 border">`+comments+`</th>`
            table.appendChild(newRow);
          };
            // Initial row delete setup (for static row)

  async function overallProcess(dataStage2) {
    const res = await fetch ("/overall", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(dataStage2),
    });

    console.log(res);

    if (!res.ok){
      throw new Error("HTTP error " + res.status);
    }

    const json = await res.json();

    return (json);
  }

  async function runPythonScript(data) {
    const res = await fetch("/individual", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });

    console.log (res);

    if (!res.ok){
       throw new Error("HTTP error " + res.status);
    }
    const json = await res.json();
    console.log("Response from Python:", json);
    return json;
  }

  document.getElementById('explain').addEventListener('click', ()=>{
    alert ("Search: searches and processes the team which is entered in the search bar data including graphs generated on the raw data page\n\nPull From Public: pulls input data from the communal public file rather than from your personal data when green, your TEAM's publically stored data when blue, and your locally stored data when red")
  });
        
</script>
</html>