<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crow's Nest</title>
  <link rel="icon" type="image/x-icon" href="favico/favicon.ico">
  <link href="datastyle.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4" id="table">
    <div id="title">
      <h1 class="text-3xl font-bold mb-4">Schedule Analysis</h1>
    </div>
    <div class="mb-4 flex justify-between items-center">
      <button id="button" class="button">manual add</button>
      <button id="newEvent" class="button">New Event</button>
    </div>
    <div class="overflow-auto border rounded-lg shadow bg-white">
      <table class="min-w-full table-fixed">
        <thead class="bg-gray-200 text-left">
          <tr>
            <th class="p-2 border">winstate</th>
            <th class="p-2 border">blue score</th>
            <th class="p-2 border">red score</th>
            <th class="p-2 border">confidence</th>
          </tr>
        </thead>
        <tbody id="data-table-body">
        </tbody>
      </table>
    </div>
  </div>
</body>
<script>
  var allResults = {}
  var alliances = {}
  const tableBody = document.getElementById("data-table-body");
  document.getElementById("newEvent").addEventListener("click", async () => {
    allResults = {}
    alliances = {}
    team = localStorage.getItem("team");
    Ecode = prompt ("What is the tbs event code for the event? (For example, UVM 2025 was 2025vtbur)");
    const all = await pyFullPred (Ecode);

    console.log('all: ' + all)

    matchNames = []
    matches = []

    first = true
    orderedTeams = [all[0]]
    matchNames = [all[2]]

    console.log("orderedTeams: " + orderedTeams);

    let counta = 0;
    holdMatch = [];
    matches = [];
    orderedTeams.forEach(team => {
      count += 1;
      if (count > 6) {
        count = 1;
        matches.append(holdMatch);
        holdMatch = [];
      } else {
        holdMatch.append(team);
      }
    })

    console.log('matches: ' + matches);
    console.log('matchnames: ' + matchNames);
    // all.forEach((value) => {
    //   if (value !== 'à¦†') {
    //     if (first) {
    //       matches.push(value);
    //     } else {
    //       matchNames.push(value);
    //     }
    //   } else {
    //     first = false
    //   }
    // });

    let count = 0;
    allCount = 0;

    matches.forEach(match => {
      console.log (match);
      match.push(localStorage.getItem('qrCodes'));
      prediction(match, count, name);
      count++;
      if (team == match[0] || team == match[1] || team == match[2]) {
        alliances[count] = "blue"
      } else {
        alliances[count] = "red"
      };
    });
    while (count > allCount){
      await sleep(1000);
    }
    console.log(allResults);

    for (let i = 0; i < count; i++) {
      build (allResults[i]);
    };    
  });

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

function build (results) {
  match = results[0];
  data = results[1];
  const tableBody = document.getElementById("data-table-body");
  const middleMan = data;
  console.log ("middleman: " + middleMan)
    const [
      didBlueWin, 
      blueScoreRange, redScoreRange,
      blueWinPercent, redWinPercent,
      corRP, autoRP, bargeRP
    ] = middleMan;

    if (alliances[match] == 'blue') {
      if (didBlueWin == true){
        message = "You Win";
        color = ' green';
        winPercents = blueWinPercent + '-' + redWinPercent;
      } else {
        message = "You Lose";
        color = ' redteam';
        winPercents = redWinPercent + '-' + blueWinPercent;
      }
    } else {
      if (didBlueWin != true){
        message = "You Win";
        color = ' green';
        winPercents = blueWinPercent + '-' + redWinPercent;
      } else {
        message = "You Lose";
        color = ' redteam';
        winPercents = redWinPercent + '-' + blueWinPercent;
      }
    }

    if (match != 'noMatch') {
      message += (' match ' + (match + 1));
    }

    const shellResults = document.createElement("tr");
    shellResults.innerHTML = `
        <td class="p-2 border`+color+`">`+message+`</td>
        <td class="p-2 border`+color+`">Blue score range: `+blueScoreRange+`</td>
        <td class="p-2 border`+color+`">Red score range: `+redScoreRange+`</td>
        <td class="p-2 border`+color+`">Win Odds: `+winPercents+`</td>
      `;
      
    tableBody.append(shellResults);

    const shellResults2 = document.createElement("tr");
    shellResults2.innerHTML = `
        <td class="p-2 border`+color+`">Reef RP: `+corRP+`</td>
        <td class="p-2 border`+color+`">Auto RP: `+autoRP+`</td>
        <td class="p-2 border`+color+`">Barge RP: `+bargeRP+`</td>`;
    
    tableBody.append(shellResults2);
  }

  async function prediction(input, key, name) {
    if (key == 'no key') {
      results = await predict(input);
      build (['noMatch', results])
    } else {
      allResults[key] = [name, await predict(input)];
    };

  }

  async function predict(dataArray) {
    const res = await fetch ("/matchPredinput", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(dataArray),
    });

    console.log(res);

    if (!res.ok){
      throw new Error("HTTP error " + res.status);
    }

    allCount++;

    const json = await res.json();
    console.log(json);
    return(json);
    
  }

  async function teamMatches(team, Ecode) {
    const res = await fetch ("/teamPullMatches", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify([team, Ecode]),
    });

    console.log(res);

    if (!res.ok){
      throw new Error("HTTP error " + res.status);
      alert ("Event Code was INVALID (why would you do this??)");
    }

    const json = await res.json();
    console.log(json);
    return(json);
    
  }
//document.addEventListener('DOMContentLoaded', async () => {
  // const filteredArray = [];
  //   const matches = await pyFullPred (Ecode);
  //   matches.forEach(teams => {
  //     conole.log ("Teams: " + teams);
  //     if (localStorage.getItem("team") in teams) {
  //       filteredArray.push(teams);
  //     }
  //   });
  //   conole.log ("Filtered Array: " + filteredArray);    
//})

async function pyFullPred(Ecode) {
    const res = await fetch ("/EventPred", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify([Ecode]),
    });

    console.log(res);

    if (!res.ok){
      throw new Error("HTTP error " + res.status);
      alert ("Event Code was INVALID (why would you do this??)");
    }

    const json = await res.json();
    console.log(json);
    return(json);
    
  }
</script>
</html>