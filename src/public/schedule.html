<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crow's Nest</title>
  <link rel="icon" type="image/x-icon" href="favico/favicon.ico">
  <link href="datastyle.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4" id="table">
    <div id="title">
      <h1 class="text-3xl font-bold mb-4">Schedule Analysis</h1>
    </div>
    <div class="mb-4 flex justify-between items-center">
      <button id="modePublic" class="On">Pull From Public</button>
      <button id="newEventAssumed" class="button">Reimport</button>
      <button id="newEvent" class="button">New Event</button>
      <button id="explain" class="button">Explain</button>
    </div>
    <div class="overflow-auto border rounded-lg shadow bg-white">
      <table class="min-w-full table-fixed">
        <thead class="bg-gray-200 text-left">
          <tr>
            <th class="p-2 border">winstate</th>
            <th class="p-2 border">blue score</th>
            <th class="p-2 border">red score</th>
            <th class="p-2 border">confidence</th>
            <th class="p-2 border">Auto RP</th>
            <th class="p-2 border">Reef RP</th>
            <th class="p-2 border">Barge RP</th>
            <th class="p-2 border">Statbotics Link</th>
          </tr>
        </thead>
        <tbody id="data-table-body">
        </tbody>
      </table>
    </div>
  </div>
</body>
<script>
  var allResults = {}
  var alliances = {}
  var teams = {}
  let modeState = 1;
  document.getElementById('modePublic').addEventListener("click", () => {
    modeState += 1;
    if (modeState > 2) {
      modeState = 0;
    }
    if (modeState == 0) {
      document.getElementById('modePublic').style.color = "#ff0000";
    } else if (modeState == 1) {
      document.getElementById('modePublic').style.color = "#00ff00";
    } else {
      document.getElementById('modePublic').style.color = "#0000ff";
    }
  });
  const tableBody = document.getElementById("data-table-body");

  document.getElementById("newEventAssumed").addEventListener("click", async () => {
    allResults = {}
    alliances = {}
    teams = {}
    team = localStorage.getItem("team");
    Ecode = localStorage.getItem('eventCode')
    const all = await teamMatches(team, Ecode);

    const matches = all[0];
    const matchNames = all[1];
    
    console.log (matches);

    let count = 0;
    allCount = 0;

    matches.forEach(match => {
      /**console.log('team: ' + team);
      console.log ('match: ' + match);
      console.log ('match[0]: ' + match[0]);
      console.log ('match[0] == team: ' + (match[0] == team));
      console.log ('team == match[0] || team == match[1] || team == match[2]: ' + (team == match[0] || team == match[1] || team == match[2]));
      console.log ('matchNames[count]: ' + matchNames[count])**/
      match.push(localStorage.getItem('qrCodes'));
      prediction(match, count, matchNames[count]);
      if (team == match[0] || team == match[1] || team == match[2]) {
        alliances[matchNames[count]] = "blue"
      } else {
        alliances[matchNames[count]] = "red"
      };
      teams[count] = [match[0], match[1], match[2], match[3], match[4], match[5]]
      /**console.log('alliances[matchNames[count]]: ' + alliances[matchNames[count]])
      console.log('alliances[qm4]: ' + alliances['qm4'])**/
      count++;
    });
    while (count > allCount){
      await sleep(1000);
    }
    console.log(allResults);

    for (let i = 0; i < count; i++) {
      build (allResults[i], i);
    };
  });


  document.getElementById("newEvent").addEventListener("click", async () => {
    allResults = {}
    alliances = {}
    teams = {}
    team = localStorage.getItem("team");
    Ecode = prompt ("What is the tbs event code for the event? (For example, UVM 2025 was 2025vtbur)");
    localStorage.setItem('eventCode', Ecode);
    const all = await teamMatches(team, Ecode);

    const matches = all[0];
    const matchNames = all[1];
    
    console.log (matches);

    let count = 0;
    allCount = 0;

    matches.forEach(match => {
      /**console.log('team: ' + team);
      console.log ('match: ' + match);
      console.log ('match[0]: ' + match[0]);
      console.log ('match[0] == team: ' + (match[0] == team));
      console.log ('team == match[0] || team == match[1] || team == match[2]: ' + (team == match[0] || team == match[1] || team == match[2]));
      console.log ('matchNames[count]: ' + matchNames[count])**/
      match.push(localStorage.getItem('qrCodes'));
      prediction(match, count, matchNames[count]);
      if (team == match[0] || team == match[1] || team == match[2]) {
        alliances[matchNames[count]] = "blue"
      } else {
        alliances[matchNames[count]] = "red"
      };
      teams[count] = [match[0], match[1], match[2], match[3], match[4], match[5]]
      /**console.log('alliances[matchNames[count]]: ' + alliances[matchNames[count]])
      console.log('alliances[qm4]: ' + alliances['qm4'])**/
      count++;
    });
    while (count > allCount){
      await sleep(1000);
    }
    console.log(allResults);

    for (let i = 0; i < count; i++) {
      build (allResults[i], i);
    };
  });

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

function build (results, aKey) {
  match = results[0];
  data = results[1];
  relTeams = teams[aKey];
  const tableBody = document.getElementById("data-table-body");
  const middleMan = data;
  console.log ("middleman: " + middleMan)
    const [
      didBlueWin, 
      blueScoreRange, redScoreRange,
      blueWinPercent, redWinPercent,
      corRPb, autoRPb, bargeRPb,
      corRPr, autoRPr, bargeRPr
    ] = middleMan;

    /**console.log('alliances: ' + alliances);
    console.log('match: ' + match);
    console.log('alliances[match]: ' + alliances[match]);
    console.log('alliances[qm4]: ' + alliances['qm4'])**/

    if (alliances[match] == 'blue') {
      autoRP = autoRPb;
      bargeRP = bargeRPb;
      corRP = corRPb;
      if (didBlueWin == true){
        message = "You Win";
        color = ' green';
        winPercents = blueWinPercent + '-' + redWinPercent;
      } else {
        message = "You Lose";
        color = ' redteam';
        winPercents = redWinPercent + '-' + blueWinPercent;
      }
    } else {
      autoRP = autoRPr;
      bargeRP = bargeRPr;
      corRP = corRPr;
      if (didBlueWin != true){
        message = "You Win";
        color = ' green';
        winPercents = blueWinPercent + '-' + redWinPercent;
      } else {
        message = "You Lose";
        color = ' redteam';
        winPercents = redWinPercent + '-' + blueWinPercent;
      }
    }

    if (match != 'noMatch') {
      message += (' match: ' + match);
    }

    const shellResults = document.createElement("tr");
        if (match.includes('q')){
      shellResults.innerHTML = `
          <a href="fullMatchBreakdown.html" target="_blank" class="p-2 border`+color+`">`+message+`</a>
          <td class="p-2 border`+color+`">Blue score range: (`+relTeams[0]+','+relTeams[1]+','+relTeams[2]+'): '+blueScoreRange+`</td>
          <td class="p-2 border`+color+`">Red score range: (`+relTeams[3]+','+relTeams[4]+','+relTeams[5]+'): '+redScoreRange+`</td>
          <td class="p-2 border`+color+`">Win Odds: `+winPercents+`</td>
          <td class="p-2 border`+color+`">Auto RP: `+autoRP+`%</td>
          <td class="p-2 border`+color+`">Reef RP: `+corRP+`%</td>
          <td class="p-2 border`+color+`">Barge RP: `+bargeRP+`%</td>
          <a href="https://www.statbotics.io/match/`+localStorage.getItem('eventCode')+'_'+match+`" target="_blank" class="p-2 border`+color+`">`+message+`</a>
        `;
    } else if (match.includes('s')){
      relMatchNum = ''
      instance = ''
      for (i = 0; i<match.length; i++) {
        if (i < match.length-1) {
          if ('1234567890'.includes(match[i])){
            relMatchNum += match[i]
          }
        } else {
          instance = match[i]
        }
      }
      shellResults.innerHTML = `
          <a href="fullMatchBreakdown.html" target="_blank" class="p-2 border`+color+`">`+message+`</a>
          <td class="p-2 border`+color+`">Blue score range: (`+relTeams[0]+','+relTeams[1]+','+relTeams[2]+'): '+blueScoreRange+`</td>
          <td class="p-2 border`+color+`">Red score range: (`+relTeams[3]+','+relTeams[4]+','+relTeams[5]+'): '+redScoreRange+`</td>
          <td class="p-2 border`+color+`">Win Odds: `+winPercents+`</td>
          <td class="p-2 border`+color+`">Auto RP: `+autoRP+`%</td>
          <td class="p-2 border`+color+`">Reef RP: `+corRP+`%</td>
          <td class="p-2 border`+color+`">Barge RP: `+bargeRP+`%</td>
          <a href="https://www.statbotics.io/match/`+localStorage.getItem('eventCode')+'_sf'+relMatchNum+'m'+instance+`" target="_blank" class="p-2 border`+color+`">`+message+`</a>
        `;
    } else {
      relMatchNum = ''
      instance = ''
      for (i = 0; i<match.length; i++) {
        if (i < match.length-1) {
          if ('1234567890'.includes(match[i])){
            relMatchNum += match[i]
          }
        } else {
          instance = match[i]
        }
      }
      shellResults.innerHTML = `
          <a href="fullMatchBreakdown.html" target="_blank" class="p-2 border`+color+`">`+message+`</a>
          <td class="p-2 border`+color+`">Blue score range: (`+relTeams[0]+','+relTeams[1]+','+relTeams[2]+'): '+blueScoreRange+`</td>
          <td class="p-2 border`+color+`">Red score range: (`+relTeams[3]+','+relTeams[4]+','+relTeams[5]+'): '+redScoreRange+`</td>
          <td class="p-2 border`+color+`">Win Odds: `+winPercents+`</td>
          <td class="p-2 border`+color+`">Auto RP: `+autoRP+`%</td>
          <td class="p-2 border`+color+`">Reef RP: `+corRP+`%</td>
          <td class="p-2 border`+color+`">Barge RP: `+bargeRP+`%</td>
          <a href="https://www.statbotics.io/match/`+localStorage.getItem('eventCode')+'_f'+relMatchNum+'m'+instance+`" target="_blank" class="p-2 border`+color+`">`+message+`</a>

        `;
    }
      
    tableBody.append(shellResults);
  }

  async function prediction(input, key, name) {
    if (modeState == 2) {
      inputH = [modeState, localStorage.getItem('team')];
      input = inputH.concat(input);
    } else {
      inputH = [modeState];
      input = inputH.concat(input);
    }
    if (key == 'no key') {
      results = await predict(input);
      build (['noMatch', results])
    } else {
      allResults[key] = [name, await predict(input)];
    };

  }

  async function predict(dataArray) {
    const res = await fetch ("/matchPredinput", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(dataArray),
    });

    console.log(res);

    if (!res.ok){
      throw new Error("HTTP error " + res.status);
    }

    allCount++;

    const json = await res.json();
    console.log(json);
    return(json);
    
  }

  async function teamMatches(team, Ecode) {
    const res = await fetch ("/teamPullMatches", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify([team, Ecode]),
    });

    console.log(res);

    if (!res.ok){
      throw new Error("HTTP error " + res.status);
      alert ("Event Code was INVALID (why would you do this??)");
    }

    const json = await res.json();
    console.log(json);
    return(json);
    
  }
//document.addEventListener('DOMContentLoaded', async () => {
  // const filteredArray = [];
  //   const matches = await pyFullPred (Ecode);
  //   matches.forEach(teams => {
  //     conole.log ("Teams: " + teams);
  //     if (localStorage.getItem("team") in teams) {
  //       filteredArray.push(teams);
  //     }
  //   });
  //   conole.log ("Filtered Array: " + filteredArray);    
//})

async function pyFullPred(Ecode) {
    const res = await fetch ("/EventPred", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify([Ecode]),
    });

    console.log(res);

    if (!res.ok){
      throw new Error("HTTP error " + res.status);
      alert ("Event Code was INVALID (why would you do this??)");
    }

    const json = await res.json();
    console.log(json);
    return(json);
  }
  document.getElementById('explain').addEventListener('click', ()=>{
    alert ("Pull From Public: a toggleable mode which dictates where the data is coming from - green means from the communal public file, blue means from your TEAM's personal data, not just your local, red means just the local data stored on this device.\n\nmanual add: nothing, I don't know why I put that there.\n\nReimport: runs the program to analyze the event from your team's perspective (predicts every match including playoffs that your team is going to be in as well as the ranking points you will score for that match).\n\nNew Event: allows you to change your locally stored event and predict the new one. If everything is breaking, you may have just never reset the event code so try doing that. If you don't know how to find it, it's in TBA links, like the 2025nhsal in https://www.thebluealliance.com/event/2025nhsal.");
  });
</script>
</html>