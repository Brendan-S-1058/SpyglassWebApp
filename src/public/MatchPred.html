<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crow's Nest</title>
  <link rel="icon" type="image/x-icon" href="favico/favicon.ico">
  <link href="datastyle.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4" id="table">
    <div id="title">
      <h1 class="text-3xl font-bold mb-4">Match Predictor</h1>
    </div>
    <div class="mb-4 flex justify-between items-center">
      <button id="modePublic" class="On">Pull From Public</button>
      <button id="predict" class="button">Predict Match</button>
      <button id="paste" class="button">Paste Teams (csv)</button>
      <button id="fullEvent" class="button">Predict Event</button>
      <button id="explain" class="button">Explain</button>
    </div>
    <div class="overflow-auto border rounded-lg shadow bg-white"  >
      <table class="min-w-full table-fixed">
        <thead class="bg-gray-200 text-left">
          <th>Blue Alliance</th>
          <th>Red Alliance</th>
        </thead>
        <tbody>          
          <tr>
            <td><input id="team1" type="text" placeholder="Blue Team 1" class="button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 blueteam"></input></td>
            <td><input id="team4" type="text" placeholder="Red Team 1" class="button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 redteam"></input></td>
          </tr>
          <tr>
            <td><input id="team2" type="text" placeholder="Blue Team 2" class="button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 blueteam"></input></td>
            <td><input id="team5" type="text" placeholder="Red Team 2" class="button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 redteam"></input></td>
          </tr>
          <tr>
            <td><input id="team3" type="text" placeholder="Blue Team 3" class="button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 blueteam"></input></td>
            <td><input id="team6" type="text" placeholder="Red Team 3" class="button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 redteam"></input></td>
          </tr>
        </tbody>
        <tbody id="data-table-body">
        </tbody>

        <tbody id="results-table">
        </tbody>
      </table>
      <div id="images"></div>
    </div>
  </div>
</body>
<script>
  var allResults = {};
  var allCount = 0;
  var alliances = {};
  var rPsByTeam = {};
  let modeState = 1;
  document.getElementById('modePublic').addEventListener("click", () => {
    modeState += 1;
    if (modeState > 2) {
      modeState = 0;
    }
    if (modeState == 0) {
      document.getElementById('modePublic').style.color = "#ff0000";
    } else if (modeState == 1) {
      document.getElementById('modePublic').style.color = "#00ff00";
    } else {
      document.getElementById('modePublic').style.color = "#0000ff";
    }
  });
  document.getElementById('fullEvent').addEventListener('click', () =>{
    const eventCode = prompt("please input the event id (UVM 2025 was 2025vtbur)").toLowerCase();

    const tableBody = document.getElementById("data-table-body");
    
    tableBody.innerHTML = ``;

    FullPrediction (eventCode)
  });
  document.getElementById("paste").addEventListener('click', () => {
    const tableBody = document.getElementById("data-table-body");
    
    tableBody.innerHTML = ``;

    const teams = prompt("Please paste in a csv line for your six teams (blue1,blue2,blue3,red1,red2,red3):");

    let allTeams = teams.split(",");
    allTeams.push (localStorage.getItem("qrCodes"));

    console.log (allTeams);

    prediction (allTeams, 'no key', 'na');
  });
  
  document.getElementById("predict").addEventListener('click', ()=>{
    const tableBody = document.getElementById("data-table-body");

    tableBody.innerHTML = ``;

    const allTeams = [
    document.getElementById("team1").value.toLowerCase(),
    document.getElementById("team2").value.toLowerCase(),
    document.getElementById("team3").value.toLowerCase(),
    document.getElementById("team4").value.toLowerCase(),
    document.getElementById("team5").value.toLowerCase(), 
    document.getElementById("team6").value.toLowerCase(),
    localStorage.getItem("qrCodes")
    ];

    prediction (allTeams, 'no key', 'na');
  });

  async function FullPrediction(Ecode) {
    allResults = {};
    alliances = {};
    rPsByTeam = {};
    all = [];

    all = await pyFullPred (Ecode);
    console.log('all: ' + all);

    matchNames = all[1];
    matches = all[0];

    let count = 0;
    allCount = 0;

    matches.forEach((teams)=> {
      rPsByTeam[teams[0]] = 0;
      rPsByTeam[teams[1]] = 0;
      rPsByTeam[teams[2]] = 0;
      rPsByTeam[teams[3]] = 0;
      rPsByTeam[teams[4]] = 0;
      rPsByTeam[teams[5]] = 0;
      console.log (teams);
      teams.push(localStorage.getItem('qrCodes'));
      prediction(teams, count, matchNames[count]);
      count++;
    });
    while (count > allCount){
      await sleep(1000);
    }
    console.log(allResults);

    for (let i = 0; i < count; i++) {
      build (allResults[i], i, true);
    }; 

    console.log('building all rankings');
    buildRankings ();
  }

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function buildRankings () {
    const tableBody = document.getElementById("results-table");

    vals = Object.entries(rPsByTeam);
    console.log(vals);
    rps = [];
    final = [];

    vals.forEach((teamPair) => {
      rps.push(teamPair[1]);
    });

    rps.sort((a, b) => b - a);

    newRps = [];
    count = 0;

    rps.forEach((rp) => {
      if (count > 0) {
        if (rp != rps[count-1]) {
          newRps.push(rp);
        }
      } else {
        newRps.push(rp);
      }
      count++;
    });
    console.log(rps);
    console.log(newRps);

    newRps.forEach((rp) => {
      for (let i = 0; i<vals.length; i++) {
        console.log(vals[i][1]);
        console.log(rp);
        if (rp == vals[i][1]) {
          final.push(vals[i]);
        }
      }
    });

    console.log(final);

    count = 0;
    final.forEach((pair) => {
      count++
      console.log('pair: ' + pair)
      const shellResults = document.createElement("tr");
      shellResults.innerHTML = `
        <td class="p-2 border redteam">`+count+`: `+pair[0]+`</td>
        <td class="p-2 border redteam">predicted RPs: `+pair[1]/100+`</td>
      `;
      
      tableBody.append(shellResults);
    });
  }

  async function pyFullPred(Ecode) {
    const res = await fetch ("/EventPred", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify([Ecode]),
    });

    console.log(res);

    if (!res.ok){
      throw new Error("HTTP error " + res.status);
      alert ("Event Code was INVALID (why would you do this??)");
    }

    const json = await res.json();
    console.log(json);
    return(json);
    
  }


  document.getElementById('explain').addEventListener('click', ()=>{
    alert ("not written yet");
});

  async function prediction(input, key, name) {
    if (key == 'no key') {
      alliances[0] = input;
      if (modeState == 2) {
        inputH = [modeState, localStorage.getItem('team')];
        input = inputH.concat(input);
      } else {
        inputH = [modeState];
        input = inputH.concat(input);
      }
      results = await predict(input);
      build (['noMatch', results], 0, false)
    } else {
      alliances[key] = (input)
      if (modeState == 2) {
        inputH = [modeState, localStorage.getItem('team')];
        input = inputH.concat(input);
      } else {
        inputH = [modeState];
        input = inputH.concat(input);
      }
      allResults[key] = [name, await predict(input)];
    };

  }
function build (results, aKey, fullPred) {
  teams = alliances[aKey];
  match = results[0];
  data = results[1];
  const tableBody = document.getElementById("data-table-body");
  const middleMan = data;
    const [
      didBlueWin, 
      blueScoreRange, redScoreRange,
      blueWinPercent, redWinPercent,
      travRPb, enerRPb, superRPb,
      travRPr, enerRPr, superRPr
    ] = middleMan;

    if (didBlueWin == true){
      message = "Blue Wins";
      color = ' blueteam';
      winPercents = blueWinPercent + '-' + redWinPercent;
    } else {
      message = "Red Wins";
      color = ' redteam';
      winPercents = redWinPercent + '-' + blueWinPercent;
    }

    if (match != 'noMatch') {
      message += (' match ' + (match));
    }

    const shellResults = document.createElement("tr");
    if (match.includes('q')){
      shellResults.innerHTML = `
          <a href="https://www.statbotics.io/match/`+localStorage.getItem('eventCode')+'_'+match+`" target="_blank" class="p-2 border`+color+`">`+message+`</a>
          <td class="p-2 border`+color+`">Blue score range: (`+teams[0]+','+teams[1]+','+teams[2]+'): '+blueScoreRange+`</td>
          <td class="p-2 border`+color+`">Red score range: (`+teams[3]+','+teams[4]+','+teams[5]+'): '+redScoreRange+`</td>
          <td class="p-2 border`+color+`">Win Odds: `+winPercents+`</td>
        `;
    } else if (match.includes('s')){
      relMatchNum = ''
      instance = ''
      for (i = 0; i<match.length; i++) {
        if (i < match.length-1) {
          if ('1234567890'.includes(match[i])){
            relMatchNum += match[i]
          }
        } else {
          instance = match[i]
        }
      }
      shellResults.innerHTML = `
          <a href="https://www.statbotics.io/match/`+localStorage.getItem('eventCode')+'_sf'+relMatchNum+'m'+instance+`" target="_blank" class="p-2 border`+color+`">`+message+`</a>
          <td class="p-2 border`+color+`">Blue score range: (`+teams[0]+','+teams[1]+','+teams[2]+'): '+blueScoreRange+`</td>
          <td class="p-2 border`+color+`">Red score range: (`+teams[3]+','+teams[4]+','+teams[5]+'): '+redScoreRange+`</td>
          <td class="p-2 border`+color+`">Win Odds: `+winPercents+`</td>
        `;
    } else {
      relMatchNum = ''
      instance = ''
      for (i = 0; i<match.length; i++) {
        if (i < match.length-1) {
          if ('1234567890'.includes(match[i])){
            relMatchNum += match[i]
          }
        } else {
          instance = match[i]
        }
      }
      shellResults.innerHTML = `
          <a href="https://www.statbotics.io/match/`+localStorage.getItem('eventCode')+'_f'+relMatchNum+'m'+instance+`" target="_blank" class="p-2 border`+color+`">`+message+`</a>
          <td class="p-2 border`+color+`">Blue score range: (`+teams[0]+','+teams[1]+','+teams[2]+'): '+blueScoreRange+`</td>
          <td class="p-2 border`+color+`">Red score range: (`+teams[3]+','+teams[4]+','+teams[5]+'): '+redScoreRange+`</td>
          <td class="p-2 border`+color+`">Win Odds: `+winPercents+`</td>
        `;
    }
      
    tableBody.append(shellResults);

    if (fullPred) {
      if (didBlueWin){
        rPsByTeam[teams[0]] += travRPb + enerRPb + superRPb + 3;
        rPsByTeam[teams[1]] += travRPb + enerRPb + superRPb + 3;
        rPsByTeam[teams[2]] += travRPb + enerRPb + superRPb + 3;
        rPsByTeam[teams[3]] += travRPr + enerRPr + superRPr;
        rPsByTeam[teams[4]] += travRPr + enerRPr + superRPr;
        rPsByTeam[teams[5]] += travRPr + enerRPr + superRPr;
      } else {
        rPsByTeam[teams[0]] += travRPb + enerRPb + superRPb;
        rPsByTeam[teams[1]] += travRPb + enerRPb + superRPb;
        rPsByTeam[teams[2]] += travRPb + enerRPb + superRPb;
        rPsByTeam[teams[3]] += travRPr + enerRPr + superRPr + 3;
        rPsByTeam[teams[4]] += travRPr + enerRPr + superRPr + 3;
        rPsByTeam[teams[5]] += travRPr + enerRPr + superRPr + 3;
      }
    }
  }

  async function predict(dataArray) {
    const res = await fetch ("/matchPredinput", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(dataArray),
    });

    console.log(res);

    if (!res.ok){
      throw new Error("HTTP error " + res.status);
    }

    allCount++;

    const json = await res.json();
    console.log(json);
    return(json);
    
  }


  document.getElementById('explain').addEventListener('click', ()=>{
    alert ("Public data storage: defaults to green, which is a public import of data from the entire community using spyglass at the moment. Interacting once with the button changes its mode to team public, represented by blue, which pulls data from the public file for your team. Interacting twice will turn the button red, and this will make the page pull only locally stored data from your device.\n\nPredict Match: Predicts a match using the selected data set defined by the teams listed in the 2X3 array below.\n\nPaste Teams (csv): Same functionality as the Predict Match button, but allows the user to paste the teams in a standard csv format (blue1,blue2,blue3,red1,red2,red3)\n\nPredict Event: Using the data from the specified location, will predict the entire event given. This does use the bluealliance api, so it needs the event id, most easily found in bluealliance urls, for example the 2025nhsal in https://www.thebluealliance.com/event/2025nhsal. This prediction does every match it can with the data provided including playoffs, and also creates a prediction for the end of event rankings at the bottom. Obviouslt, accuracy increases with the data set, so this entire page should probably only be used later in the event.");
});
</script>
</html>