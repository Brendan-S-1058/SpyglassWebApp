<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crow's Nest</title>
  <link rel="icon" type="image/x-icon" href="favico/favicon.ico">
  <link href="datastyle.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4" id="table">
    <div id="title">
      <h1 class="text-3xl font-bold mb-4">Match Predictor</h1>
    </div>
    <div class="mb-4 flex justify-between items-center">
      <button id="predict" class="button">Predict Match</button>
      <button id="paste" class="button">Paste Teams (csv)</button>
      <button id="fullEvent" class="button">Predict Event</button>
      <button id="explain" class="button">Explain</button>
    </div>
    <div class="overflow-auto border rounded-lg shadow bg-white"  >
      <table class="min-w-full table-fixed">
        <thead class="bg-gray-200 text-left">
          <th>Blue Alliance</th>
          <th>Red Alliance</th>
        </thead>
        <tbody>          
          <tr>
            <td><input id="team1" type="text" placeholder="Blue Team 1" class="button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 blueteam"></input></td>
            <td><input id="team4" type="text" placeholder="Red Team 1" class="button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 redteam"></input></td>
          </tr>
          <tr>
            <td><input id="team2" type="text" placeholder="Blue Team 2" class="button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 blueteam"></input></td>
            <td><input id="team5" type="text" placeholder="Red Team 2" class="button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 redteam"></input></td>
          </tr>
          <tr>
            <td><input id="team3" type="text" placeholder="Blue Team 3" class="button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 blueteam"></input></td>
            <td><input id="team6" type="text" placeholder="Red Team 3" class="button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 redteam"></input></td>
          </tr>
        </tbody>
        <tbody id="data-table-body">
        </tbody>
      </table>
      <div id="images"></div>
    </div>
  </div>
</body>
<script>
  var allResults = {};
  var allCount = 0;
  var alliances = {};
  var rPsByTeam = {};
  document.getElementById('fullEvent').addEventListener('click', () =>{
    const eventCode = prompt("please input the event id (UVM 2025 was 2025vtbur)").toLowerCase()

    FullPrediction (eventCode)
  });
  document.getElementById("paste").addEventListener('click', () => {
    const tableBody = document.getElementById("data-table-body");
    
    tableBody.innerHTML = ``;

    const teams = prompt("Please paste in a csv line for your six teams (blue1,blue2,blue3,red1,red2,red3):");

    let allTeams = teams.split(",");
    allTeams.push (localStorage.getItem("qrCodes"));

    console.log (allTeams);

    prediction (allTeams, 'no key', 'na');
  });
  
  document.getElementById("predict").addEventListener('click', ()=>{
    const tableBody = document.getElementById("data-table-body");

    tableBody.innerHTML = ``;

    const allTeams = [
    document.getElementById("team1").value.toLowerCase(),
    document.getElementById("team2").value.toLowerCase(),
    document.getElementById("team3").value.toLowerCase(),
    document.getElementById("team4").value.toLowerCase(),
    document.getElementById("team5").value.toLowerCase(), 
    document.getElementById("team6").value.toLowerCase(),
    localStorage.getItem("qrCodes")
    ];

    prediction (allTeams, 'no key', 'na');
  });

  async function FullPrediction(Ecode) {
    allResults = {};
    alliances = {};
    rPsByTeam = {};
    all = [];

    all = await pyFullPred (Ecode);
    console.log('all: ' + all);

    matchNames = all[1];
    matches = all[0];

    let count = 0;
    allCount = 0;

    matches.forEach((teams)=> {
      rPsByTeam[teams[0]] = 0;
      rPsByTeam[teams[1]] = 0;
      rPsByTeam[teams[2]] = 0;
      rPsByTeam[teams[3]] = 0;
      rPsByTeam[teams[4]] = 0;
      rPsByTeam[teams[5]] = 0;
      console.log (teams);
      teams.push(localStorage.getItem('qrCodes'));
      prediction(teams, count, matchNames[count]);
      count++;
    });
    while (count > allCount){
      await sleep(1000);
    }
    console.log(allResults);

    for (let i = 0; i < count; i++) {
      build (allResults[i], i, true);
    }; 

    console.log('building all rankings');
    buildRankings ();
  }

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function buildRankings () {
    const tableBody = document.getElementById("data-table-body");

    vals = Object.entries(rPsByTeam);
    console.log(vals);
    rps = [];
    final = [];

    vals.forEach((teamPair) => {
      rps.push(teamPair[1]);
    });

    rps.sort((a, b) => b[1] - a[1]);

    newRps = [];
    count = 0;

    rps.forEach((rp) => {
      if (count > 0) {
        if (rp != rps[count-1]) {
          newRps.push(rp)
        }
      }
      count++;
    });
    console.log(rps);
    console.log(newRps);

    newRps.forEach((rp) => {
      for (let i = 0; i<vals.length; i++) {
        if (rp == vals[i][0]) {
          final.push(vals[i]);
        }
      }
    });

    final.forEach((pair) => {
      const shellResults = document.createElement("tr");
      shellResults.innerHTML = `
        <td class="p-2 border redteam">`+pair[0]+pair[1]+`</td>
      `;
      
      tableBody.append(shellResults);
    });
  }

  async function pyFullPred(Ecode) {
    const res = await fetch ("/EventPred", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify([Ecode]),
    });

    console.log(res);

    if (!res.ok){
      throw new Error("HTTP error " + res.status);
      alert ("Event Code was INVALID (why would you do this??)");
    }

    const json = await res.json();
    console.log(json);
    return(json);
    
  }


  document.getElementById('explain').addEventListener('click', ()=>{
    alert ("not written yet");
});

  async function prediction(input, key, name) {
    if (key == 'no key') {
      results = await predict(input);
      alliances[0] = input;
      build (['noMatch', results], 0, false)
    } else {
      allResults[key] = [name, await predict(input)];
      alliances[key] = (input)
    };

  }
function build (results, aKey, fullPred) {
  teams = alliances[aKey];
  match = results[0];
  data = results[1];
  const tableBody = document.getElementById("data-table-body");
  const middleMan = data;
    const [
      didBlueWin, 
      blueScoreRange, redScoreRange,
      blueWinPercent, redWinPercent,
      corRPb, autoRPb, bargeRPb,
      corRPr, autoRPr, bargeRPr
    ] = middleMan;

    if (didBlueWin == true){
      message = "Blue Wins";
      color = ' blueteam';
      winPercents = blueWinPercent + '-' + redWinPercent;
    } else {
      message = "Red Wins";
      color = ' redteam';
      winPercents = redWinPercent + '-' + blueWinPercent;
    }

    if (match != 'noMatch') {
      message += (' match ' + (match));
    }

    const shellResults = document.createElement("tr");
    shellResults.innerHTML = `
        <td class="p-2 border`+color+`">`+message+`</td>
        <td class="p-2 border`+color+`">Blue score range: (`+teams[0]+','+teams[1]+','+teams[2]+') '+blueScoreRange+`</td>
        <td class="p-2 border`+color+`">Red score range: (`+teams[3]+','+teams[4]+','+teams[5]+') '+redScoreRange+`</td>
        <td class="p-2 border`+color+`">Win Odds: `+winPercents+`</td>
      `;
      
    tableBody.append(shellResults);

    if (fullPred) {
      rPsByTeam[teams[0]] += bargeRPb + autoRPb + corRPb;
      rPsByTeam[teams[1]] += bargeRPb + autoRPb + corRPb;
      rPsByTeam[teams[2]] += bargeRPb + autoRPb + corRPb;
      rPsByTeam[teams[3]] += bargeRPr + autoRPr + corRPr;
      rPsByTeam[teams[4]] += bargeRPr + autoRPr + corRPr;
      rPsByTeam[teams[5]] += bargeRPr + autoRPr + corRPr;
    }
  }

  async function predict(dataArray) {
    const res = await fetch ("/matchPredinput", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(dataArray),
    });

    console.log(res);

    if (!res.ok){
      throw new Error("HTTP error " + res.status);
    }

    allCount++;

    const json = await res.json();
    console.log(json);
    return(json);
    
  }


  document.getElementById('explain').addEventListener('click', ()=>{
    alert ("not written yet");
});
</script>
</html>