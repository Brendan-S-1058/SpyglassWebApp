<!DOCTYPE html>
<html>

<head>
    <link rel="icon" type="image/x-icon" href="favico/favicon.ico">
    <title>Sypglass</title>
    <meta charset="UTF-8">
    <link href="datastyle.css" rel="stylesheet">
</head>
<body>
    <div class="container mx-auto p-4" id="table">
        <div id="title">
            <h1 class="text-3xl font-bold mb-4">Spyglass</h1>
        </div>
        <button id="explain" class="button">Explain</button>
        <a href="input.html">Input</a>
        <a href="scan.html">Scan</a>
        <a href="data.html">Raw Data</a>
        <a href="dataProcessed.html">Processed Data</a>
        <a href="pickList.html">Pick List</a>
        <a href="MatchPred.html">Match Predictor</a>
        <button id="changeTeam" class="button">Change Team</button>
    </div>
</body>
<script>
    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('team') == null) {
        team = prompt("What team are you on (just the number: ex. 1058). If you only want to access public data, enter 'guest'");
          while (team == null) {
            team = prompt ("What team are you on (just the number: ex. 1058). If you only want to access public data, enter 'guest'");
          }

        ThouShallPerchancePass (team)
        }
      });
    
    async function ThouShallPerchancePass(team) {
        if ((team.toLowerCase()) != 'guest'){
            checkPassword = await FindPasswordByTeam (team);
            response = checkPassword.split(',');

            if (response[0] != 'False') {
                if (response[1] != 'yes') {
                  enteredpass = prompt ("please enter your team's password:")
                  while (enteredpass != response[0]) {
                      enteredpass = prompt ("YIKES (wrong password, make sure you're using the right password for this event, it could have changed)");
                  }
                  localStorage.setItem('isAdmin', 'no')
                } else {
                  enteredpass = prompt ("please enter your team's password:")
                  while (enteredpass != response[0] && enteredpass != response[2]) {
                      enteredpass = prompt ("YIKES (wrong password, make sure you're using the right password for this event, it could have changed)");
                  }
                  if (enteredpass == response[0]){
                    AllStall ()
                  } else {
                    localStorage.setItem('isAdmin', 'yes')
                  }
                }
                localStorage.setItem("team", team);
            } else {
              localStorage.setItem('isAdmin', 'no')
                newPass = prompt ("your team has not yet set a password for this event, you can set one, but you CAN NOT RESET IT, so share it with your team in some digital way AS SOON AS YOU MAKE IT");
                while (newPass == "") {
                  newPass = prompt ("No, you should really set a password")
                }
                setPass (team, newPass);
                localStorage.setItem("team", team);
            }


        } else {
            localStorage.setItem("team", "guest");
        }  
    }

    document.getElementById('explain').addEventListener("click", () => {
        alert("Welcome to Spyglass - Team 1058's online scouting database! this is a fairly complicated and potentially unintuitive system, so if you're ever confused you can just read the 'explain' buttons on each page. As a brief description of each of those pages\n\ninput allows you to input data on the fly in a more simple way than other pages, allowing you to either generate a qr code for the scanner by using the static site input.brendansai.ch, or automatically saving it to your local storage on this site\n\nscan is the site which allows you to collect data from those generating qr codes and use it collectively without the use of internet\n\ndata refers to a raw data page which allows you to edit lines of data, export to the public file, or search\n\nprocessed data is a page of processed data for a single team's emtire event, and shows any graphs generated on the raw data page\n\npicklist generates a list of teams sorted by highest average score to lowest, and also includes a graph comparing teams' average auto and teleop score");
    });

    document.getElementById('changeTeam').addEventListener("click", () => {
      confirm = prompt ("Are you sure you want to change your team (you should not need to do this often unless I add event specific stuff and forget to remove this), respond with y/n");
      if (confirm == 'y') {
        team = prompt("What team are you on (just the number: ex. 1058). If you only want to access public data without saving anything, enter 'guest'");
        while (team == null) {
            team = prompt ("What team are you on (just the number: ex. 1058). If you only want to access public data, enter 'guest'");
          }
        
        ThouShallPerchancePass (team);
      }
    });

    async function AllStall() {
      setInterval (await pyStall, 60000)
    }

    async function pyStall() {
      console.log ("stalling")
        const res = await fetch ("/oneMinute", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(['Nothing']),
      });

      console.log(res);

      if (!res.ok){
        throw new Error("HTTP error " + res.status);
        alert ("Event Code was INVALID (why would you do this??)");
      }

      const json = await res.json();
      console.log(json);
      return(json);
    }

    async function FindPasswordByTeam (teamNumber) {
    const res = await fetch ("/FindPassword", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify([teamNumber]),
    });

    if (!res.ok){
      throw new Error("HTTP error " + res.status);
      alert ("Event Code was INVALID (why would you do this??)");
    }

    const json = await res.json();
    return(json);
    
  }

  async function setPass (teamNumber, newPass) {
    const res = await fetch ("/setPassword", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify([teamNumber, newPass]),
    });

    console.log(res);

    if (!res.ok){
      throw new Error("HTTP error " + res.status);
      alert ("Event Code was INVALID (why would you do this??)");
    }

    const json = await res.json();
    console.log(json);
    return(json);
    
  }

</script>

</html>